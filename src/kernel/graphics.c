#include "graphics.h"

// Address where bootloader stores framebuffer info
#define FB_INFO_ADDR 0x8000

// Global framebuffer state
static FramebufferInfo fb_info;
static volatile uint8_t *framebuffer = 0;
static int graphics_available = 0;

// Simple 8x16 bitmap font (ASCII 32-126)
// Each character is 8 pixels wide, 16 pixels tall
static const uint8_t font8x16[95][16] = {
    // Space (32)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // ! (33)
    {0x00, 0x00, 0x18, 0x3C, 0x3C, 0x3C, 0x18, 0x18,
     0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},
    // " (34)
    {0x00, 0x66, 0x66, 0x66, 0x24, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // # (35)
    {0x00, 0x00, 0x00, 0x6C, 0x6C, 0xFE, 0x6C, 0x6C,
     0x6C, 0xFE, 0x6C, 0x6C, 0x00, 0x00, 0x00, 0x00},
    // $ (36)
    {0x18, 0x18, 0x7C, 0xC6, 0xC2, 0xC0, 0x7C, 0x06,
     0x06, 0x86, 0xC6, 0x7C, 0x18, 0x18, 0x00, 0x00},
    // % (37)
    {0x00, 0x00, 0x00, 0x00, 0xC2, 0xC6, 0x0C, 0x18,
     0x30, 0x60, 0xC6, 0x86, 0x00, 0x00, 0x00, 0x00},
    // & (38)
    {0x00, 0x00, 0x38, 0x6C, 0x6C, 0x38, 0x76, 0xDC,
     0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00},
    // ' (39)
    {0x00, 0x30, 0x30, 0x30, 0x60, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // ( (40)
    {0x00, 0x00, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x30,
     0x30, 0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00},
    // ) (41)
    {0x00, 0x00, 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x0C,
     0x0C, 0x0C, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00},
    // * (42)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x3C, 0xFF,
     0x3C, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // + (43)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x7E,
     0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // , (44)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x18, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00},
    // - (45)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // . (46)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},
    // / (47)
    {0x00, 0x00, 0x00, 0x00, 0x02, 0x06, 0x0C, 0x18,
     0x30, 0x60, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00},
    // 0 (48)
    {0x00, 0x00, 0x38, 0x6C, 0xC6, 0xC6, 0xD6, 0xD6,
     0xC6, 0xC6, 0x6C, 0x38, 0x00, 0x00, 0x00, 0x00},
    // 1 (49)
    {0x00, 0x00, 0x18, 0x38, 0x78, 0x18, 0x18, 0x18,
     0x18, 0x18, 0x18, 0x7E, 0x00, 0x00, 0x00, 0x00},
    // 2 (50)
    {0x00, 0x00, 0x7C, 0xC6, 0x06, 0x0C, 0x18, 0x30,
     0x60, 0xC0, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00},
    // 3 (51)
    {0x00, 0x00, 0x7C, 0xC6, 0x06, 0x06, 0x3C, 0x06,
     0x06, 0x06, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    // 4 (52)
    {0x00, 0x00, 0x0C, 0x1C, 0x3C, 0x6C, 0xCC, 0xFE,
     0x0C, 0x0C, 0x0C, 0x1E, 0x00, 0x00, 0x00, 0x00},
    // 5 (53)
    {0x00, 0x00, 0xFE, 0xC0, 0xC0, 0xC0, 0xFC, 0x06,
     0x06, 0x06, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    // 6 (54)
    {0x00, 0x00, 0x38, 0x60, 0xC0, 0xC0, 0xFC, 0xC6,
     0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    // 7 (55)
    {0x00, 0x00, 0xFE, 0xC6, 0x06, 0x06, 0x0C, 0x18,
     0x30, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00},
    // 8 (56)
    {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0xC6,
     0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    // 9 (57)
    {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7E, 0x06,
     0x06, 0x06, 0x0C, 0x78, 0x00, 0x00, 0x00, 0x00},
    // : (58)
    {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00,
     0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},
    // ; (59)
    {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00,
     0x00, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00},
    // < (60)
    {0x00, 0x00, 0x00, 0x06, 0x0C, 0x18, 0x30, 0x60,
     0x30, 0x18, 0x0C, 0x06, 0x00, 0x00, 0x00, 0x00},
    // = (61)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00,
     0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // > (62)
    {0x00, 0x00, 0x00, 0x60, 0x30, 0x18, 0x0C, 0x06,
     0x0C, 0x18, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00},
    // ? (63)
    {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0x0C, 0x18, 0x18,
     0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},
    // @ (64)
    {0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xDE, 0xDE,
     0xDE, 0xDC, 0xC0, 0x7C, 0x00, 0x00, 0x00, 0x00},
    // A (65)
    {0x00, 0x00, 0x10, 0x38, 0x6C, 0xC6, 0xC6, 0xFE,
     0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00},
    // B (66)
    {0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x66,
     0x66, 0x66, 0x66, 0xFC, 0x00, 0x00, 0x00, 0x00},
    // C (67)
    {0x00, 0x00, 0x3C, 0x66, 0xC2, 0xC0, 0xC0, 0xC0,
     0xC0, 0xC2, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00},
    // D (68)
    {0x00, 0x00, 0xF8, 0x6C, 0x66, 0x66, 0x66, 0x66,
     0x66, 0x66, 0x6C, 0xF8, 0x00, 0x00, 0x00, 0x00},
    // E (69)
    {0x00, 0x00, 0xFE, 0x66, 0x62, 0x68, 0x78, 0x68,
     0x60, 0x62, 0x66, 0xFE, 0x00, 0x00, 0x00, 0x00},
    // F (70)
    {0x00, 0x00, 0xFE, 0x66, 0x62, 0x68, 0x78, 0x68,
     0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00},
    // G (71)
    {0x00, 0x00, 0x3C, 0x66, 0xC2, 0xC0, 0xC0, 0xDE,
     0xC6, 0xC6, 0x66, 0x3A, 0x00, 0x00, 0x00, 0x00},
    // H (72)
    {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xFE, 0xC6,
     0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00},
    // I (73)
    {0x00, 0x00, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18,
     0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00},
    // J (74)
    {0x00, 0x00, 0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
     0xCC, 0xCC, 0xCC, 0x78, 0x00, 0x00, 0x00, 0x00},
    // K (75)
    {0x00, 0x00, 0xE6, 0x66, 0x66, 0x6C, 0x78, 0x78,
     0x6C, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00},
    // L (76)
    {0x00, 0x00, 0xF0, 0x60, 0x60, 0x60, 0x60, 0x60,
     0x60, 0x62, 0x66, 0xFE, 0x00, 0x00, 0x00, 0x00},
    // M (77)
    {0x00, 0x00, 0xC6, 0xEE, 0xFE, 0xFE, 0xD6, 0xC6,
     0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00},
    // N (78)
    {0x00, 0x00, 0xC6, 0xE6, 0xF6, 0xFE, 0xDE, 0xCE,
     0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00},
    // O (79)
    {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
     0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    // P (80)
    {0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x60,
     0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00},
    // Q (81)
    {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
     0xC6, 0xD6, 0xDE, 0x7C, 0x0C, 0x0E, 0x00, 0x00},
    // R (82)
    {0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x6C,
     0x66, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00},
    // S (83)
    {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0x60, 0x38, 0x0C,
     0x06, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    // T (84)
    {0x00, 0x00, 0xFF, 0xDB, 0x99, 0x18, 0x18, 0x18,
     0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00},
    // U (85)
    {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
     0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    // V (86)
    {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
     0xC6, 0x6C, 0x38, 0x10, 0x00, 0x00, 0x00, 0x00},
    // W (87)
    {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xD6, 0xD6,
     0xD6, 0xFE, 0xEE, 0x6C, 0x00, 0x00, 0x00, 0x00},
    // X (88)
    {0x00, 0x00, 0xC6, 0xC6, 0x6C, 0x7C, 0x38, 0x38,
     0x7C, 0x6C, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00},
    // Y (89)
    {0x00, 0x00, 0xC3, 0xC3, 0xC3, 0x66, 0x3C, 0x18,
     0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00},
    // Z (90)
    {0x00, 0x00, 0xFE, 0xC6, 0x86, 0x0C, 0x18, 0x30,
     0x60, 0xC2, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00},
    // [ (91)
    {0x00, 0x00, 0x3C, 0x30, 0x30, 0x30, 0x30, 0x30,
     0x30, 0x30, 0x30, 0x3C, 0x00, 0x00, 0x00, 0x00},
    // \ (92)
    {0x00, 0x00, 0x00, 0x80, 0xC0, 0x60, 0x30, 0x18,
     0x0C, 0x06, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00},
    // ] (93)
    {0x00, 0x00, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
     0x0C, 0x0C, 0x0C, 0x3C, 0x00, 0x00, 0x00, 0x00},
    // ^ (94)
    {0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // _ (95)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00},
    // ` (96)
    {0x00, 0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    // a (97)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x0C, 0x7C,
     0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00},
    // b (98)
    {0x00, 0x00, 0xE0, 0x60, 0x60, 0x78, 0x6C, 0x66,
     0x66, 0x66, 0x66, 0x7C, 0x00, 0x00, 0x00, 0x00},
    // c (99)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC0,
     0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    // d (100)
    {0x00, 0x00, 0x1C, 0x0C, 0x0C, 0x3C, 0x6C, 0xCC,
     0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00},
    // e (101)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xFE,
     0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    // f (102)
    {0x00, 0x00, 0x38, 0x6C, 0x64, 0x60, 0xF0, 0x60,
     0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00},
    // g (103)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xCC, 0xCC,
     0xCC, 0xCC, 0xCC, 0x7C, 0x0C, 0xCC, 0x78, 0x00},
    // h (104)
    {0x00, 0x00, 0xE0, 0x60, 0x60, 0x6C, 0x76, 0x66,
     0x66, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00},
    // i (105)
    {0x00, 0x00, 0x18, 0x18, 0x00, 0x38, 0x18, 0x18,
     0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00},
    // j (106)
    {0x00, 0x00, 0x06, 0x06, 0x00, 0x0E, 0x06, 0x06,
     0x06, 0x06, 0x06, 0x06, 0x66, 0x66, 0x3C, 0x00},
    // k (107)
    {0x00, 0x00, 0xE0, 0x60, 0x60, 0x66, 0x6C, 0x78,
     0x78, 0x6C, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00},
    // l (108)
    {0x00, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18,
     0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00},
    // m (109)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xE6, 0xFF, 0xDB,
     0xDB, 0xDB, 0xDB, 0xDB, 0x00, 0x00, 0x00, 0x00},
    // n (110)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x66, 0x66,
     0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00},
    // o (111)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC6,
     0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    // p (112)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x66, 0x66,
     0x66, 0x66, 0x66, 0x7C, 0x60, 0x60, 0xF0, 0x00},
    // q (113)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xCC, 0xCC,
     0xCC, 0xCC, 0xCC, 0x7C, 0x0C, 0x0C, 0x1E, 0x00},
    // r (114)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x76, 0x66,
     0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00},
    // s (115)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0x60,
     0x38, 0x0C, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    // t (116)
    {0x00, 0x00, 0x10, 0x30, 0x30, 0xFC, 0x30, 0x30,
     0x30, 0x30, 0x36, 0x1C, 0x00, 0x00, 0x00, 0x00},
    // u (117)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xCC, 0xCC, 0xCC,
     0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00},
    // v (118)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xC3, 0xC3, 0xC3,
     0xC3, 0x66, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00},
    // w (119)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0xC6, 0xC6,
     0xD6, 0xD6, 0xFE, 0x6C, 0x00, 0x00, 0x00, 0x00},
    // x (120)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0x6C, 0x38,
     0x38, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00},
    // y (121)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0xC6, 0xC6,
     0xC6, 0xC6, 0xC6, 0x7E, 0x06, 0x0C, 0xF8, 0x00},
    // z (122)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xCC, 0x18,
     0x30, 0x60, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00},
    // { (123)
    {0x00, 0x00, 0x0E, 0x18, 0x18, 0x18, 0x70, 0x18,
     0x18, 0x18, 0x18, 0x0E, 0x00, 0x00, 0x00, 0x00},
    // | (124)
    {0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18,
     0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},
    // } (125)
    {0x00, 0x00, 0x70, 0x18, 0x18, 0x18, 0x0E, 0x18,
     0x18, 0x18, 0x18, 0x70, 0x00, 0x00, 0x00, 0x00},
    // ~ (126)
    {0x00, 0x00, 0x76, 0xDC, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
};

#define FONT_WIDTH 8
#define FONT_HEIGHT 16

// Initialize graphics from bootloader info
void graphics_init(void) {
  // Read framebuffer info from known address
  FramebufferInfo *src = (FramebufferInfo *)FB_INFO_ADDR;

  // Copy to local structure
  fb_info = *src;

  // Check if we have a valid framebuffer
  if (fb_info.framebuffer_addr != 0 && fb_info.width > 0 && fb_info.height > 0 &&
      fb_info.bpp >= 24) {
    framebuffer = (volatile uint8_t *)(uintptr_t)fb_info.framebuffer_addr;
    graphics_available = 1;
  } else {
    graphics_available = 0;
  }
}

int graphics_is_available(void) { 
  return graphics_available; 
}

FramebufferInfo *graphics_get_info(void) { 
  return &fb_info; 
}

// Put a pixel at (x, y) with given color
void graphics_put_pixel(int x, int y, uint32_t color) {
  if (!graphics_available)
    return;
  if (x < 0 || x >= (int)fb_info.width || y < 0 || y >= (int)fb_info.height)
    return;

  uint32_t offset = y * fb_info.pitch + x * (fb_info.bpp / 8);

  if (fb_info.bpp == 32) {
    *(uint32_t *)(framebuffer + offset) = color;
  } else if (fb_info.bpp == 24) {
    framebuffer[offset + 0] = (color >> fb_info.blue_field_pos) & 0xFF;
    framebuffer[offset + 1] = (color >> fb_info.green_field_pos) & 0xFF;
    framebuffer[offset + 2] = (color >> fb_info.red_field_pos) & 0xFF;
  }
}

uint32_t graphics_get_pixel(int x, int y) {
  if (!graphics_available)
    return 0;
  if (x < 0 || x >= (int)fb_info.width || y < 0 || y >= (int)fb_info.height)
    return 0;

  uint32_t offset = y * fb_info.pitch + x * (fb_info.bpp / 8);

  if (fb_info.bpp == 32) {
    return *(uint32_t *)(framebuffer + offset);
  } else if (fb_info.bpp == 24) {
    return framebuffer[offset + 0] | (framebuffer[offset + 1] << 8) |
           (framebuffer[offset + 2] << 16);
  }
  return 0;
}

// Clear screen with a single color
void graphics_clear(uint32_t color) {
  if (!graphics_available)
    return;

  for (uint32_t y = 0; y < fb_info.height; y++) {
    for (uint32_t x = 0; x < fb_info.width; x++) {
      graphics_put_pixel(x, y, color);
    }
  }
}

// Draw rectangle outline
void graphics_draw_rect(int x, int y, int w, int h, uint32_t color) {
  // Top and bottom
  for (int i = 0; i < w; i++) {
    graphics_put_pixel(x + i, y, color);
    graphics_put_pixel(x + i, y + h - 1, color);
  }
  // Left and right
  for (int i = 0; i < h; i++) {
    graphics_put_pixel(x, y + i, color);
    graphics_put_pixel(x + w - 1, y + i, color);
  }
}

// Fill rectangle
void graphics_fill_rect(int x, int y, int w, int h, uint32_t color) {
  for (int j = 0; j < h; j++) {
    for (int i = 0; i < w; i++) {
      graphics_put_pixel(x + i, y + j, color);
    }
  }
}

// Draw line using Bresenham's algorithm
void graphics_draw_line(int x0, int y0, int x1, int y1, uint32_t color) {
  int dx = x1 - x0;
  int dy = y1 - y0;
  int sx = (dx > 0) ? 1 : -1;
  int sy = (dy > 0) ? 1 : -1;
  dx = (dx < 0) ? -dx : dx;
  dy = (dy < 0) ? -dy : dy;

  int err = dx - dy;

  while (1) {
    graphics_put_pixel(x0, y0, color);
    if (x0 == x1 && y0 == y1)
      break;
    int e2 = 2 * err;
    if (e2 > -dy) {
      err -= dy;
      x0 += sx;
    }
    if (e2 < dx) {
      err += dx;
      y0 += sy;
    }
  }
}

// Draw circle outline using midpoint algorithm
void graphics_draw_circle(int cx, int cy, int radius, uint32_t color) {
  int x = radius;
  int y = 0;
  int err = 0;

  while (x >= y) {
    graphics_put_pixel(cx + x, cy + y, color);
    graphics_put_pixel(cx + y, cy + x, color);
    graphics_put_pixel(cx - y, cy + x, color);
    graphics_put_pixel(cx - x, cy + y, color);
    graphics_put_pixel(cx - x, cy - y, color);
    graphics_put_pixel(cx - y, cy - x, color);
    graphics_put_pixel(cx + y, cy - x, color);
    graphics_put_pixel(cx + x, cy - y, color);

    y++;
    err += 1 + 2 * y;
    if (2 * (err - x) + 1 > 0) {
      x--;
      err += 1 - 2 * x;
    }
  }
}

// Fill circle
void graphics_fill_circle(int cx, int cy, int radius, uint32_t color) {
  for (int y = -radius; y <= radius; y++) {
    for (int x = -radius; x <= radius; x++) {
      if (x * x + y * y <= radius * radius) {
        graphics_put_pixel(cx + x, cy + y, color);
      }
    }
  }
}

// Draw a single character
void graphics_draw_char(int x, int y, char c, uint32_t fg, uint32_t bg) {
  if (!graphics_available)
    return;
  if (c < 32 || c > 126)
    c = ' ';

  const uint8_t *glyph = font8x16[c - 32];

  for (int row = 0; row < FONT_HEIGHT; row++) {
    uint8_t bits = glyph[row];
    for (int col = 0; col < FONT_WIDTH; col++) {
      if (bits & (0x80 >> col)) {
        graphics_put_pixel(x + col, y + row, fg);
      } else {
        graphics_put_pixel(x + col, y + row, bg);
      }
    }
  }
}

// Draw a string
void graphics_draw_string(int x, int y, const char *str, uint32_t fg,
                          uint32_t bg) {
  int start_x = x;
  while (*str) {
    if (*str == '\n') {
      x = start_x;
      y += FONT_HEIGHT;
    } else if (*str == '\r') {
      x = start_x;
    } else {
      graphics_draw_char(x, y, *str, fg, bg);
      x += FONT_WIDTH;
    }
    str++;
  }
}

int graphics_get_font_width(void) { 
  return FONT_WIDTH; 
}

int graphics_get_font_height(void) { 
  return FONT_HEIGHT; 
}

// Draw a 3D-style border (Windows 95 style)
void graphics_draw_3d_border(int x, int y, int w, int h, int raised) {
  uint32_t light = RGB(255, 255, 255);
  uint32_t dark = RGB(128, 128, 128);
  uint32_t darker = RGB(64, 64, 64);
  
  if (raised) {
    // Top and left edges (light)
    graphics_draw_line(x, y, x + w - 1, y, light);
    graphics_draw_line(x, y, x, y + h - 1, light);
    // Bottom and right edges (dark)
    graphics_draw_line(x, y + h - 1, x + w - 1, y + h - 1, darker);
    graphics_draw_line(x + w - 1, y, x + w - 1, y + h - 1, darker);
    // Inner shadow
    graphics_draw_line(x + 1, y + h - 2, x + w - 2, y + h - 2, dark);
    graphics_draw_line(x + w - 2, y + 1, x + w - 2, y + h - 2, dark);
  } else {
    // Sunken: reverse the colors
    graphics_draw_line(x, y, x + w - 1, y, darker);
    graphics_draw_line(x, y, x, y + h - 1, darker);
    graphics_draw_line(x + 1, y + 1, x + w - 2, y + 1, dark);
    graphics_draw_line(x + 1, y + 1, x + 1, y + h - 2, dark);
    graphics_draw_line(x, y + h - 1, x + w - 1, y + h - 1, light);
    graphics_draw_line(x + w - 1, y, x + w - 1, y + h - 1, light);
  }
}

// Draw a panel with optional 3D border
void graphics_draw_panel(int x, int y, int w, int h, uint32_t bg, int style) {
  graphics_fill_rect(x, y, w, h, bg);
  if (style == 1) {  // PANEL_RAISED
    graphics_draw_3d_border(x, y, w, h, 1);
  } else if (style == 2) {  // PANEL_SUNKEN
    graphics_draw_3d_border(x, y, w, h, 0);
  }
}

// Draw a window with title bar
void graphics_draw_window(int x, int y, int w, int h, const char *title, uint32_t title_bg, uint32_t bg) {
  int title_height = FONT_HEIGHT + 6;
  
  // Window background
  graphics_fill_rect(x, y, w, h, bg);
  
  // Outer 3D border (raised)
  graphics_draw_3d_border(x, y, w, h, 1);
  
  // Title bar
  graphics_fill_rect(x + 3, y + 3, w - 6, title_height, title_bg);
  
  // Title text (centered)
  int title_len = 0;
  const char *t = title;
  while (*t++) title_len++;
  int text_x = x + (w - title_len * FONT_WIDTH) / 2;
  int text_y = y + 5;
  graphics_draw_string(text_x, text_y, title, RGB(255, 255, 255), title_bg);
  
  // Inner content area border (sunken)
  int content_y = y + title_height + 5;
  int content_h = h - title_height - 8;
  graphics_draw_3d_border(x + 3, content_y, w - 6, content_h, 0);
}

// Draw a button
void graphics_draw_button(int x, int y, int w, int h, const char *label, int pressed) {
  uint32_t bg = RGB(192, 192, 192);
  
  graphics_fill_rect(x, y, w, h, bg);
  graphics_draw_3d_border(x, y, w, h, !pressed);
  
  // Center label
  int label_len = 0;
  const char *l = label;
  while (*l++) label_len++;
  int text_x = x + (w - label_len * FONT_WIDTH) / 2;
  int text_y = y + (h - FONT_HEIGHT) / 2;
  if (pressed) {
    text_x++;
    text_y++;
  }
  graphics_draw_string(text_x, text_y, label, RGB(0, 0, 0), bg);
}

// Draw a progress bar
void graphics_draw_progress_bar(int x, int y, int w, int h, int percent, uint32_t fg, uint32_t bg) {
  if (percent < 0) percent = 0;
  if (percent > 100) percent = 100;
  
  // Background with sunken border
  graphics_fill_rect(x, y, w, h, bg);
  graphics_draw_3d_border(x, y, w, h, 0);
  
  // Fill bar
  int fill_w = ((w - 4) * percent) / 100;
  if (fill_w > 0) {
    graphics_fill_rect(x + 2, y + 2, fill_w, h - 4, fg);
  }
}

// Draw text with drop shadow
void graphics_draw_shadow_text(int x, int y, const char *str, uint32_t fg, uint32_t shadow) {
  // Draw shadow first (offset by 1,1)
  graphics_draw_string(x + 1, y + 1, str, shadow, shadow);
  // Draw foreground text (transparent background - use shadow color)
  graphics_draw_string(x, y, str, fg, shadow);
}
